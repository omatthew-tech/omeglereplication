<h1>{{ chat_room.room_name }} Room</h1>
<div id="streams-container">
{% for message in messages %}
  <div class="stream">
    <h2>{{ message.sender }}'s Stream</h2>
    <video id="{{ message.sender }}-stream" autoplay></video>
  </div>
{% endfor %}
</div>
<script>
  const streamsContainer = document.getElementById("streams-container");
  const socket = new WebSocket("ws://" + window.location.host + "/live_stream/");
  
  socket.onmessage = (event) => {
    const data = JSON.parse(event.data);
    const type = data.type;
    const payload = data.payload;
    
    if (type === "offer") {
      const senderStream = document.getElementById(`${payload.sender}-stream`);
      const stream = new MediaStream();
      senderStream.srcObject = stream;
      const peerConnection = new RTCPeerConnection();
      peerConnection.addStream(stream);
      peerConnection.setRemoteDescription(new RTCSessionDescription(payload.offer));
      peerConnection.createAnswer().then((answer) => {
        peerConnection.setLocalDescription(answer);
        socket.send(JSON.stringify({
          type: "answer",
          answer: answer
        }));
      });
    } else if (type === "answer") {
      const senderStream = document.getElementById(`${payload.sender}-stream`);
      const stream = new MediaStream();
      senderStream.srcObject = stream;
      const peerConnection = new RTCPeerConnection();
      peerConnection.addStream(stream);
      peerConnection.setRemoteDescription(new RTCSessionDescription(payload.answer));
    }
  };
</script>